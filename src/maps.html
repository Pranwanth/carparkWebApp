<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title> Nearby carpark</title>
    <link rel="stylesheet" href="project.css" />
    <style>
      #map {
        height: 600px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    
    <button onclick="location.href='index.html'">Back to search</button>
    <div id="map"></div>   
    <script>

       fetch("https://api.data.gov.sg/v1/transport/carpark-availability") // get carpark availability api
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          text = JSON.stringify(data);
          localStorage.setItem("carparkAvailibity", text);
        });

        function findcarparkinfo(target) {
        text = localStorage.getItem("carparkAvailibity");

        data = JSON.parse(text);

        for (i = 0; i < data.items[0].carpark_data.length; i++) {
          if (data.items[0].carpark_data[i].carpark_number == target) {
            console.log(data.items[0].carpark_data[i]);
            console.log(
              "available: " +
                data.items[0].carpark_data[i].carpark_info[0].lots_available +
                " / " +
                data.items[0].carpark_data[i].carpark_info[0].total_lots
            );
            avail_lots =
              data.items[0].carpark_data[i].carpark_info[0].lots_available;
            total_lots =
              data.items[0].carpark_data[i].carpark_info[0].total_lots;

              return [avail_lots,total_lots];
          }
        }

        
      }

      function calculateDistance(){

      text=localStorage.getItem("nearbycarpark");
        nearbycarpark=JSON.parse(text);
        text = localStorage.getItem("search coordinates");
        coordinates = JSON.parse(text);
        var origin=new google.maps.LatLng(coordinates.latitude, coordinates.longitude);
        var destination=[];
        for(i=0;i<nearbycarpark.length;i++)
        {
          if(i>20) //api limit
            break;
          destination.push({ lat: nearbycarpark[i].x_coord, lng: nearbycarpark[i].y_coord})
        }
      
         var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix(
       {
            origins: [origin],
           destinations: destination,
           travelMode: 'WALKING',
           avoidHighways: false,
            avoidTolls: false,
          }, get_distance);
      
        }

      function initMap() {
        // Map options
        text = localStorage.getItem("search coordinates");
        coordinates = JSON.parse(text);
        console.log(coordinates);

        var options = {
          zoom: 16,
          center: { lat: coordinates.latitude, lng: coordinates.longitude },
          zoomControl: false,
          mapTypeControl: false,
          scaleControl: false,
          streetViewControl: false,
  
        };

        // New map
        var map = new google.maps.Map(document.getElementById("map"), options);

        

      
          // markers array has first element: the search coordinates
        var markers = [
          
          {
            coords: { lat: coordinates.latitude, lng: coordinates.longitude },

          },
        ];

        
        
    




        
      


        // generating info window for each car park( rates, availability etc)
        text=localStorage.getItem("nearbycarpark");
        nearbycarpark=JSON.parse(text);
        for(i=0;i<nearbycarpark.length;i++)
        {
          
          

          if(nearbycarpark[i].lots_available==null)
            nearbycarpark[i].lots_available="N/A";
          
          
            str=nearbycarpark[i].address+"<p></p>"+" Available: "+nearbycarpark[i].lots_available+"<p></p>"+"Walking duration: "+nearbycarpark[i].duration+"<p></p>"+"Weekday rates: "+nearbycarpark[i].weekdayRate+"/30mins"+"<p></p>"+"Sat rates: "+nearbycarpark[i].satdayRate+"/30mins"+"<p></p>"+"Sun rates: "+nearbycarpark[i].sunPHRate+"/30mins<p></p>";
          
         

          markers.push( {
            coords: { lat: nearbycarpark[i].x_coord, lng: nearbycarpark[i].y_coord },
            iconImage:
              "http://maps.google.com/mapfiles/ms/icons/parkinglot.png",
            content: str,
          },)
        }
       
        // Loop through markers get nearest 5(6 including destination) list sorted according to distance
        for (var i = 0; i <6; i++) {
          // Add marker
          if(i==nearbycarpark.length+1)
            break;
          if(markers[i]!=null)
            addMarker(markers[i]);
        }

        function createmarker() {}

        // Add Marker Function
        function addMarker(props) {
          var marker = new google.maps.Marker({
            position: props.coords,
            map: map,
            //icon:props.iconImage
          });

          // Check for customicon
          if (props.iconImage) {
            // Set icon image
            marker.setIcon(props.iconImage);
          }

          // Check content
          if (props.content) {
            var infoWindow = new google.maps.InfoWindow({
              content: props.content,
            });

            marker.addListener("click", function () {
              infoWindow.open(map, marker);
            });
          }
        }
      }
      




function get_distance(response, status) {

text=localStorage.getItem("nearbycarpark");
nearbycarpark=JSON.parse(text);

if (status == 'OK') {
  var origins = response.originAddresses;
  var destinations = response.destinationAddresses;
  console.log(response);
  
  for (var i = 0; i < origins.length; i++) {
    var results = response.rows[i].elements;
    console.log(results);
 
    for (var j = 0; j < results.length; j++) {
      var element = results[j];
      console.log(element);
      nearbycarpark[j].distance = element.distance.text;
      nearbycarpark[j].duration = element.duration.text;
      var from = origins[i];
      var to = destinations[j];
    }
  }
}

for(i=1;i<nearbycarpark.length;i++) //arrange carpark according to duration
{
  for(j=i;j>0;j--)
			{
				d1=nearbycarpark[j-1].duration;
				d2=nearbycarpark[j].duration;
				if(d1>d2)
				{
					temp= nearbycarpark[j];
					nearbycarpark[j]=nearbycarpark[j-1];
					nearbycarpark[j-1]=temp;
				}
				else
					break;
			}



}



  text=JSON.stringify(nearbycarpark);
  localStorage.setItem("nearbycarpark",text);

  
  initMap(); //generate map
}

    </script>
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDPXWT4iTaB2hL_E-NAiMROYvxEJAptfM&callback=calculateDistance"// will call the setup funtion
    ></script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-analytics.js";
      import { getDatabase, ref, set, child, update, remove, push } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
    
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBHq25W2RREUFHfM5xXRXD-fllj1YmRV-E",
        authDomain: "firsttime-17feb.firebaseapp.com",
        databaseURL: "https://firsttime-17feb-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "firsttime-17feb",
        storageBucket: "firsttime-17feb.appspot.com",
        messagingSenderId: "276395725875",
        appId: "1:276395725875:web:02048bb845a6dc5ccebf46",
        measurementId: "G-VSJTYTXJ82"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase();

      async function generate_table(nearbycarpark) {
        //text = localStorage.getItem("nearbycarpark");
        //nearbycarpark = JSON.parse(text);
        // get the reference for the body
        var body = document.getElementsByTagName("body")[0];

        // creates a <table> element and a <tbody> element
        var tbl = document.createElement("table");
        var tblBody = document.createElement("tbody");
        tbl.id = "myTable"
        // creating all cells
        for (var i = 0; i < 5; i++) {
          // creates a table row
          if(i==nearbycarpark.length)
            break;
          var row = document.createElement("tr");
          row.id = nearbycarpark[i].car_park_no;

          // Create a <td> element and a text node, make the text
          // node the contents of the <td>, and put the <td> at
          // the end of the table row
          var cell = document.createElement("td");
          var cellText = document.createTextNode(nearbycarpark[i].address);
          cell.appendChild(cellText);
          row.appendChild(cell);

          var cell = document.createElement("td");
          var cellText = document.createTextNode(nearbycarpark[i].distance);
          cell.appendChild(cellText);
          row.appendChild(cell);

          var btn = document.createElement("button");

          btn.innerHTML = "Add to favorites";
          //var cpName = row.cells[0].innerHTML;
          //var cpNum = row.id;
          //const user = "user1"
          //btn.onclick = addTofavorites(cpName, cpNum, user);
          btn.className = "btnDB";
          row.appendChild(btn);

          // add the row to the end of the table body
          tblBody.appendChild(row);
        }

        // put the <tbody> in the <table>
        tbl.appendChild(tblBody);
        // appends <table> into <body>
        body.appendChild(tbl);
        // sets the border attribute of tbl to 2;
        tbl.setAttribute("border", "2");
      }
      

      
      const text = localStorage.getItem("nearbycarpark");
      nearbycarpark = JSON.parse(text);
      generate_table(nearbycarpark);
      
      var table = document.getElementById("myTable");
      console.log("Here is the TABLE info");
      console.log(table.rows.length)
      const lenTable = table.rows.length;
      const rowArray = new Array();

      set(ref(db, "users"), null)
      
      const newPostKey = push(child(ref(db), "users")).key;
      const updates = {};
      updates['/users/' + newPostKey] = {
            favCarParks:{}
        }
      update(ref(db), updates);
      
      function addTofavorites(cpName, cpNum, user){
        const postListRef = ref(db, 'users/' + newPostKey + '/favCarParks');
        const newPostRef = push(postListRef);
        set(newPostRef, {
          carparkName: cpName,
          carParkNum: cpNum
        })
        /*update(ref(db, "users/" + newPostKey + "/favCarParks"), {
          carparkName: cpName,
          carParkNum: cpNum
        })*/
      }


      const user = "user1";

      document.querySelectorAll('.btnDB').forEach(item => {
        item.addEventListener('click', event => {
          //console.log("HERE!!!!")
          //console.log(item.parentElement.cells[0].innerHTML);
          const cpName = item.parentElement.cells[0].innerHTML;
          const cpNum = item.parentElement.id;
          addTofavorites(cpName, cpNum, user);
          })
      })
    </script>
  </body>
</html>
